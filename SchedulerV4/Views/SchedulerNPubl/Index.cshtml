@model List<SchedulerV4.Models.ScheduleNPublEntity>

@{
    ViewData["Title"] = "Расписание";
    var groupList = ViewBag.GroupList as List<SelectListItem>;
    int? filteredGroupNo = ViewBag.FilteredGroupNo as int?;
}

<style>
    .add-btn {
        display: inline-block;
        padding: 10px 25px;
        font-size: 17px;
        background-color: #28a745;
        color: white;
        border-radius: 6px;
        text-decoration: none;
        transition: background-color 0.3s ease;
    }

        .add-btn:hover {
            background-color: #218838;
        }

    .form-row {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 20px;
        background: #fff;
        padding: 30px 40px;
        border-radius: 12px;
        box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        width: 100%; /* растянуть на всю ширину */
        max-width: none; /* убрать ограничение */
        margin: 0 auto 40px;
    }

    label {
        font-size: 15px;
        color: #555;
        width: auto;
    }

    select {
        width: 350px;
        height: 50px;
        font-size: 15px;
        padding: 0 15px;
        border: 2px solid #ddd;
        border-radius: 8px;
        transition: border-color 0.3s ease;
        background-color: white;
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 15px center;
        background-size: 20px 20px;
    }

        select:focus {
            border-color: #0088CE;
            outline: none;
            box-shadow: 0 0 8px rgba(0, 136, 206, 0.3);
        }

    button {
        font-size: 15px;
        height: 48px;
        background: #0088CE;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        width: auto;
        text-align: center;
        padding: 5px 10px;
    }

        button:hover {
            background: #006fa1;
        }

    table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    th {
        background-color: #0088CE;
        color: white;
    }

    body {
        color: #333;
    }

    h1 {
        font-size: 40px;
        text-align: center;
        margin-bottom: 30px;
    }

    h2 {
        font-size: 30px;
        text-align: center;
        margin-bottom: 30px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    th, td {
        border: 1px solid #ddd;
        padding: 8px 10px;
        text-align: center;
        font-size: 15px;
    }

    th {
        background-color: #0088CE;
        color: white;
    }

    button {
        padding: 5px 10px;
        background-color: #0088CE;
        border: none;
        color: white;
        border-radius: 4px;
        cursor: pointer;
    }

        button:hover {
            background-color: #006fa1;
        }
    /* Модальное окно */
    .modal {
        display: none; /* скрыто по умолчанию */
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        justify-content: center;
        align-items: center;
    }

    .modal-content {
        background: white;
        padding: 25px 30px;
        border-radius: 10px;
        width: 500px;
        max-width: 90%;
        box-shadow: 0 8px 30px rgba(0,0,0,0.3);
    }

    .modal-header {
        font-size: 28px;
        margin-bottom: 20px;
        font-weight: bold;
        text-align: center;
    }

    .modal-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 15px;
        margin-bottom: 15px;
    }

        .modal-row label {
            width: 200px; /* одинаковая ширина у всех меток */
            font-size: 18px;
        }

        .modal-row select,
        .modal-row input[type="text"],
        .modal-row input[type="date"],
        .modal-row input[type="time"] {
            flex-grow: 1;
            font-size: 18px;
            padding: 6px 10px;
            border: 1.5px solid #ccc;
            border-radius: 6px;
            width: 100%; /* чтобы занимал доступное пространство */
            box-sizing: border-box;
        }

    .modal-footer {
        margin-top: 25px;
        text-align: center;
    }

        .modal-footer button {
            margin: 0 10px;
            padding: 10px 25px;
            font-size: 18px;
        }
</style>

<h1>Расписание занятий</h1>

@*                                     Ф И Л Ь Т Р Ы *@

<div class="form-row">
    <label for="groupSelect">Номер группы:</label>
    <select id="groupSelect" name="groupId">
        <option value="">-- Все группы --</option>
        @foreach (var group in groupList)
        {
                @if (ViewBag.SelectedGroupId?.ToString() == group.Value)
                {
                    <option value="@group.Value" selected>@group.Text</option>
                }
                else
                {
                    <option value="@group.Value">@group.Text</option>
                }
        }
    </select>
    <label for="tipSelect">Тип занятия:</label>
    <select id="tipSelect" name="tip">
        <option value="">-- Выберите тип --</option>
        @if (ViewBag.SelectedTip?.ToString() == "1")
        {
            <option value="1" selected>дневное</option>
        }
        else
        {
            <option value="1">дневное</option>
        }
        @if (ViewBag.SelectedTip?.ToString() == "2")
        {
            <option value="2" selected>экзамен</option>
        }
        else
        {
            <option value="2">экзамен</option>
        }
        @if (ViewBag.SelectedTip?.ToString() == "3")
        {
            <option value="3" selected>заочное</option>
        }
        else
        {
            <option value="3">заочное</option>
        }
    </select>

    <label for="yearSelect">Год:</label>
    <select id="yearSelect" name="year">
        <option value="">-- Выберите год --</option>
        @{
            int currentYear = DateTime.Now.Year;
            for (int y = currentYear - 1; y <= currentYear + 1; y++)
            {
                if (ViewBag.SelectedYear?.ToString() == y.ToString())
                {
                    <option value="@y" selected>@y</option>
                }
                else
                {
                    <option value="@y">@y</option>
                }
            }
        }
    </select>

    <label for="semesterSelect">Семестр:</label>
    <select id="semesterSelect" name="semester">
        <option value="">-- Выберите семестр --</option>
        @if (ViewBag.SelectedSemester?.ToString() == "1")
        {
            <option value="1" selected>осенний</option>
        }
        else
        {
            <option value="1">осенний</option>
        }
        @if (ViewBag.SelectedSemester?.ToString() == "2")
        {
            <option value="2" selected>весенний</option>
        }
        else
        {
            <option value="2">весенний</option>
        }
    </select>
</div>

@*                                    Кнопка Добавить при выборе группы *@

<script>
    document.getElementById('showScheduleBtn').addEventListener('click', () => {
        const groupId = document.getElementById('groupSelect').value;
        const tip = document.getElementById('tipSelect').value;
        const semester = document.getElementById('semesterSelect').value;
        const year = document.getElementById('yearSelect').value;

        const params = new URLSearchParams();

        if (groupId) params.append('groupId', groupId);
        if (tip) params.append('tip', tip);
        if (semester) params.append('semester', semester);
        if (year) params.append('year', year);

        const query = params.toString();
        window.location.href = `/SchedulerNPubl/Index${query ? '?' + query : ''}`;
    });
</script>

@if (ViewBag.ShowAddButton == true)
{
    <button type="button" id="openCreateModalBtn">Добавить занятие</button>
}

@*                                    Д О Б А В Л Е Н И Е   О К Н О *@

<div class="modal" id="createModal">
    <div class="modal-content">
        <div class="modal-header">Добавление занятия группе номер 
            @if (filteredGroupNo.HasValue)
            {
                <text>@filteredGroupNo</text>
            }
        </div>
        <form id="transferForm">
            <input type="hidden" id="createGroupNo" name="GROUPNO" value="@ViewBag.FilteredGroupNo" />
            <div class="modal-row">
                <label style="width:200px" for="createDay">День</label>
                <select name="DEN" required>
                    <option value="">Выберите день</option>
                    <option value="пн">пн</option>
                    <option value="вт">вт</option>
                    <option value="ср">ср</option>
                    <option value="чт">чт</option>
                    <option value="пт">пт</option>
                    <option value="сб">сб</option>
                </select>
            </div>
            <div class="modal-row">
                <label style="width:200px" for="paritySelect">Четность</label>
                <select id="paritySelect" name="DATA" required>
                    <option value="">Выберите</option>
                    <option value="чет/неч">чет/неч</option>
                    <option value="чет">чет</option>
                    <option value="неч">неч</option>
                </select>
            </div>
            <div class="modal-row">
                <label style="width:200px" for="createTime">Время</label>
                <select name="VREM" required>
                    <option value="">Выберите время</option>
                    <option value="08:00">08:00</option>
                    <option value="09:40">09:40</option>
                    <option value="11:20">11:20</option>
                    <option value="13:30">13:30</option>
                    <option value="15:10">15:10</option>
                    <option value="16:50">16:50</option>
                    <option value="18:25">18:25</option>
                    <option value="20:00">20:00</option>
                </select>
            </div>
            <div class="modal-row">
                <label style="width:200px" for="createDiscipline">Дисциплина</label>
                <select name="DISCIPL_NUM" required>
                    <option value="">Выберите дисциплину</option>
                    @foreach (var item in ViewBag.Disciplins as List<SelectListItem>)
                    {
                        <option value="@item.Value">@item.Text</option>
                    }
                </select>
            </div>
            <div class="modal-row">
                <label style="width:200px" for="createFormZan">Вид занятия</label>
                <select name="FORM_ZAN" required>
                    <option value="">Выберите вид занятия</option>
                    <option value="лек">лек</option>
                    <option value="пр">пр</option>
                    <option value="л.р.">л.р.</option>
                </select>
            </div>
            <div class="modal-row">
                <label style="width:200px" for="createBuilding">Здание</label>
                <select id="createBuilding" name="ZDANIE" required>
                    <option value="">Выберите здание</option>
                    @foreach (var item in ViewBag.Buildings as List<SelectListItem>)
                    {
                        <option value="@item.Value">@item.Text</option>
                    }
                </select>
            </div>
            <div class="modal-row">
                <label style="width:200px" for="createAud">Аудитория</label>
                <select id="createAud" name="AUDITORIYA" disabled required>
                    <option value="">Выберите аудиторию</option>
                </select>
            </div>
            <div class="modal-row">
                <label style="width:200px" for="createTeacher">Преподаватель</label>
                <select id="createTeacher" name="PREPODAVATEL" required>
                    <option value="">Выберите преподавателя</option>
                    @foreach (var t in ViewBag.Prepodavatels as List<SelectListItem>)
                    {
                        <option value="@t.Value">@t.Text</option>
                    }
                </select>
            </div>
            <input type="hidden" id="hiddenTip" name="TIP" />
            <input type="hidden" id="hiddenSemester" name="SEMESTR" />
            <input type="hidden" id="hiddenYear" name="YEARF" />
            <div class="modal-footer">
                <button type="submit">Добавить</button>
                <button type="button" id="cancelCreateBtn">Отмена</button>
            </div>
        </form>
    </div>
</div>

@*                                   Открытие/закрытие модального окна *@

<script>
    const createModal = document.getElementById('createModal');
    const openCreateModalBtn = document.getElementById('openCreateModalBtn');
    const cancelCreateBtn = document.getElementById('cancelCreateBtn');
    const createForm = document.getElementById('transferForm');

    openCreateModalBtn.addEventListener('click', () => {
        const groupId = document.getElementById('groupSelect').value;
        const tip = document.getElementById('tipSelect').value;
        const semester = document.getElementById('semesterSelect').value;
        const year = document.getElementById('yearSelect').value;

        if (!groupId || !tip || !semester || !year) {
            alert("Пожалуйста, выберите все фильтры: группу, тип занятия, семестр и год перед добавлением.");
            return;
        }

        document.getElementById('hiddenTip').value = tip;
        document.getElementById('hiddenSemester').value = semester;
        document.getElementById('hiddenYear').value = year;

        createModal.style.display = 'flex';
    });

    cancelCreateBtn.addEventListener('click', () => {
        createModal.style.display = 'none';
        createForm.reset();
    });

    window.addEventListener('click', (e) => {
        if (e.target === createModal) {
            createModal.style.display = 'none';
            createForm.reset();
        }
    });
</script>

@*                                    Добавление строки *@

<script>
    // Сабмит формы
        document.getElementById('transferForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const parity = document.getElementById('paritySelect').value;
        if (!parity) {
            alert("Пожалуйста, выберите четность.");
            return;
        }

        const form = e.target;
        const formData = new FormData();
        formData.append("GROUPNO", document.getElementById("createGroupNo").value);
        formData.append("DEN", form.DEN.value);
        formData.append("VREM", form.VREM.value);
        formData.append("DATA", parity); // <-- просто чётность
        formData.append("DISCIPL_NUM", form.DISCIPL_NUM.value);
        formData.append("FORM_ZAN", form.FORM_ZAN.value);
        formData.append("ZDANIE", form.ZDANIE.value);
        formData.append("AUDITORIYA", form.AUDITORIYA.value);
        formData.append("PREPODAVATEL", form.PREPODAVATEL.value);
        formData.append("TIP", document.getElementById("hiddenTip").value);
        formData.append("SEMESTR", document.getElementById("hiddenSemester").value);
        formData.append("YEARF", document.getElementById("hiddenYear").value);

        const response = await fetch('/SchedulerNPubl/Create', {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            alert("Занятие успешно добавлено!");
            document.getElementById('createModal').style.display = 'none';
            form.reset();
            updateSchedule();
        } else {
            const errorText = await response.text();
            alert("Ошибка: " + errorText);
        }
    });
</script>

@*                                    Для обновления вывода расписания *@

<script>
    function updateSchedule() {
        const groupId = document.getElementById('groupSelect').value;
        const tip = document.getElementById('tipSelect').value;
        const semester = document.getElementById('semesterSelect').value;
        const year = document.getElementById('yearSelect').value;

        const params = new URLSearchParams();

        if (groupId) params.append('groupId', groupId);
        if (tip) params.append('tip', tip);
        if (semester) params.append('semester', semester);
        if (year) params.append('year', year);

        const query = params.toString();
        window.location.href = `/SchedulerNPubl/Index${query ? '?' + query : ''}`;
    }

    // Назначение обработчиков на все селекты
    document.getElementById('groupSelect').addEventListener('change', updateSchedule);
    document.getElementById('tipSelect').addEventListener('change', updateSchedule);
    document.getElementById('semesterSelect').addEventListener('change', updateSchedule);
    document.getElementById('yearSelect').addEventListener('change', updateSchedule);
</script>

@*                                    а *@

<script>
    document.getElementById('createBuilding').addEventListener('change', async function () {
        const buildingSelect = this;
        const selectedBuilding = buildingSelect.value;
        const audSelect = document.getElementById('createAud');

        // Очистить и отключить селект аудиторий
        audSelect.innerHTML = '<option value="">Выберите аудиторию</option>';
        audSelect.disabled = true;

        if (!selectedBuilding) return;

        try {
            const response = await fetch(`/SchedulerNPubl/GetAuditoriesByBuilding?buildingName=${encodeURIComponent(selectedBuilding)}`);
            const auditories = await response.json();

            auditories.forEach(a => {
                const option = document.createElement('option');
                option.value = a.value;
                option.textContent = a.text;
                audSelect.appendChild(option);
            });

            audSelect.disabled = false;
        } catch (error) {
            console.error('Ошибка загрузки аудиторий:', error);
        }
    });
</script>

@*                                     Даты *@

<script>
    const paritySelect = document.getElementById("paritySelect");
    const daySelect = document.querySelector("select[name='DEN']");
    const semesterSelect = document.getElementById("semesterSelect");
    const yearSelect = document.getElementById("yearSelect");

    const dateOptionsByKey = {
        // весенний 2024
        "пн_весенний_2024": ["05.02", "04.03", "01.04", "06.05"],
        "вт_весенний_2024": ["06.02", "05.03", "02.04", "07.05"],
        "ср_весенний_2024": ["07.02", "06.03", "03.04", "08.05"],
        "чт_весенний_2024": ["08.02", "07.03", "04.04", "09.05"],
        "пт_весенний_2024": ["09.02", "08.03", "05.04", "10.05"],
        "сб_весенний_2024": ["03.02", "02.03", "06.04", "04.05"],

        // весенний 2025
        "пн_весенний_2025": ["03.02", "03.03", "07.04", "05.05"],
        "вт_весенний_2025": ["04.02", "04.03", "08.04", "06.05"],
        "ср_весенний_2025": ["05.02", "05.03", "09.04", "07.05"],
        "чт_весенний_2025": ["06.02", "06.03", "10.04", "08.05"],
        "пт_весенний_2025": ["07.02", "07.03", "11.04", "09.05"],
        "сб_весенний_2025": ["08.02", "08.03", "12.04", "10.05"],

        // весенний 2026
        "пн_весенний_2026": ["02.02", "02.03", "06.04", "04.05"],
        "вт_весенний_2026": ["03.02", "03.03", "07.04", "05.05"],
        "ср_весенний_2026": ["04.02", "04.03", "08.04", "06.05"],
        "чт_весенний_2026": ["05.02", "05.03", "09.04", "07.05"],
        "пт_весенний_2026": ["06.02", "06.03", "10.04", "08.05"],
        "сб_весенний_2026": ["07.02", "07.03", "11.04", "09.05"],

        // осенний 2024
        "пн_осенний_2024": ["02.09", "07.10", "04.11", "02.12"],
        "вт_осенний_2024": ["03.09", "08.10", "05.11", "03.12"],
        "ср_осенний_2024": ["04.09", "09.10", "06.11", "04.12"],
        "чт_осенний_2024": ["05.09", "10.10", "07.11", "05.12"],
        "пт_осенний_2024": ["06.09", "11.10", "08.11", "06.12"],
        "сб_осенний_2024": ["07.09", "12.10", "09.11", "07.12"],

        // осенний 2025
        "пн_осенний_2025": ["01.09", "06.10", "03.11", "01.12"],
        "вт_осенний_2025": ["02.09", "07.10", "04.11", "02.12"],
        "ср_осенний_2025": ["03.09", "08.10", "05.11", "03.12"],
        "чт_осенний_2025": ["04.09", "09.10", "06.11", "04.12"],
        "пт_осенний_2025": ["05.09", "10.10", "07.11", "05.12"],
        "сб_осенний_2025": ["06.09", "11.10", "08.11", "06.12"],

        // осенний 2026
        "пн_осенний_2026": ["07.09", "05.10", "02.11", "07.12"],
        "вт_осенний_2026": ["01.09", "06.10", "03.11", "08.12"],
        "ср_осенний_2026": ["02.09", "07.10", "04.11", "09.12"],
        "чт_осенний_2026": ["03.09", "08.10", "05.11", "10.12"],
        "пт_осенний_2026": ["04.09", "09.10", "06.11", "11.12"],
        "сб_осенний_2026": ["05.09", "10.10", "07.11", "12.12"]
    };

    function updateParityOptions() {
        const day = daySelect.value.toLowerCase();
        // Семестр: если value === "1" — осенний, иначе весенний
        const semester = semesterSelect.value === "1" ? "осенний" : "весенний";
        const year = yearSelect.value;

        if (!day || !semester || !year) {
            paritySelect.innerHTML = `<option value="">Выберите</option>`;
            paritySelect.disabled = true;
            return;
        }

        const key = `${day}_${semester}_${year}`;
        const dates = dateOptionsByKey[key];

        paritySelect.innerHTML = `
            <option value="">Выберите</option>
            <option value="чет/неч">чет/неч</option>
            <option value="чет">чет</option>
            <option value="неч">неч</option>
        `;

        if (dates && Array.isArray(dates)) {
            const datesLine = dates.join(", ");
            const opt = document.createElement("option");
            opt.value = datesLine;
            opt.textContent = datesLine;
            paritySelect.appendChild(opt);
            paritySelect.disabled = false;
        } else {
            paritySelect.disabled = true;
        }
    }

    // Изначально блокируем select
    paritySelect.disabled = true;

    // Навесим обработчики, чтобы обновлять options при изменениях
    daySelect.addEventListener("change", updateParityOptions);
    semesterSelect.addEventListener("change", updateParityOptions);
    yearSelect.addEventListener("change", updateParityOptions);
</script>


@*                                     В Ы В О Д    Р А С П И С А Н И Я *@

<h2 style="text-align:center; margin-top: 30px;">
    @if (filteredGroupNo.HasValue)
    {
        <text>Группа @filteredGroupNo</text>
    }
    else
    {
        <text>Все группы</text>
    }
</h2>

<table>
    <thead>
        <tr>
            <th>Группа</th>
            <th>День</th>
            <th>Время</th>
            <th>Дата</th>
            <th>Дисциплина</th>
            <th>Вид занятия</th>
            <th>Аудитория</th>
            <th>Здание</th>
            <th>Преподаватель</th>
            <th>Тип занятия</th>
            <th>Год расписания</th>
            <th>Семестр</th>
            <th></th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model)
        {
            <tr>
                <td>@item.GROUPNO</td>
                <td>@item.DEN</td>
                <td>@item.VREM</td>
                <td>@item.DATA</td>
                <td>@item.Discipline?.NAME</td>
                <td>@item.FORM_ZAN</td>
                <td>@item.AUDITORIYA</td>
                <td>@item.BUILDING_ID</td>
                <td>@item.PREPODAVATEL</td>
                <td>@(item.TIP == 1 ? "дневное" : (item.TIP == 2 ? "экзамен" : "заочное"))</td>
                <td>@item.YEARF</td>
                <td>@(item.SEMESTR == 1 ? "осенний" : "весенний")</td>
                <td><button class="transferBtn">Перенести</button></td>
                <td>
                    <form asp-action="Delete" method="post" style="display:inline;">
                        <input type="hidden" name="ID" value="@item.LESSON_ID" />
                        <input type="hidden" name="groupId" value="@ViewBag.SelectedGroupId" />
                        <input type="hidden" name="tip" value="@ViewBag.SelectedTip" />
                        <input type="hidden" name="semester" value="@ViewBag.SelectedSemester" />
                        <input type="hidden" name="year" value="@ViewBag.SelectedYear" />
                        <button type="submit" class="btn btn-danger">Удалить</button>
                    </form>
                </td>
            </tr>
        }
    </tbody>
</table>